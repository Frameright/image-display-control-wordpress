class t{constructor(e,i){this._id=e,this._level=t._toValue(i)}setLevel(e){this._level=t._toValue(e)}setId(t){this._id=t}debug(e){this._level>=t._DEBUG&&console.log(this._consoleText(e))}warn(e){this._level>=t._WARN&&console.warn(this._consoleText(e))}error(e){this._level>=t._ERROR&&console.error(this._consoleText(e))}static _toValue(e){const i=(e||"").toLowerCase();return"debug"===i||"trace"===i||"notice"===i?t._DEBUG:"info"===i?t._INFO:i.startsWith("warn")?t._WARN:i.startsWith("err")?t._ERROR:"fatal"===i?t._FATAL:t._OFF}_consoleText(t){return this._id?`[${this._id}] ${t}`:t}}t._OFF=0,t._FATAL=1,t._ERROR=2,t._WARN=3,t._INFO=4,t._DEBUG=5;class e{constructor(t,e){this.x=t,this.y=e}getRelativeCoord(t){return t.isUnknown()?new i:new i(this.x/t.getSafeWidth(),this.y/t.getSafeHeight())}toString(){return`{x=${this.x.toFixed(3)}px, y=${this.y.toFixed(3)}px}`}}class i{constructor(t,e){this._x=Math.max(Math.min(null!=t?t:0,1),0),this._y=Math.max(Math.min(null!=e?e:0,1),0)}getPositionInPixels(t){let i=0,n=0;return t.isUnknown()||(i=t.getWidth(),n=t.getHeight()),new e(this._x*i,this._y*n)}toString(){return`{x=${this._x.toFixed(3)}, y=${this._y.toFixed(3)}}`}}class n{constructor(t,e){this._width=Math.max(Math.min(null!=t?t:0,1),0),this._height=Math.max(Math.min(null!=e?e:0,1),0)}getSizeInPixels(t){let e=0,i=0;return t.isUnknown()||(e=t.getWidth(),i=t.getHeight()),new s(this._width*e,this._height*i)}toString(){return`{width=${this._width.toFixed(3)}, height=${this._height.toFixed(3)}}`}}class s{constructor(t,e){this._unknown=!0,this._width=0,this._height=0,null!=t&&null!=e&&(this._width=Math.max(t,0),this._height=Math.max(e,0),this._unknown=!1)}getWidth(){return this._width}getHeight(){return this._height}getSafeWidth(){return Math.max(this._width,1)}getSafeHeight(){return Math.max(this._height,1)}getSafeRatio(){return this.getSafeWidth()/this.getSafeHeight()}isUnknown(){return this._unknown}setIfDifferent(t){return!this.equals(t)&&(this._unknown=t.isUnknown(),this._width=t.getWidth(),this._height=t.getHeight(),!0)}ratioDiffFactor(t){const e=this.getSafeRatio(),i=t.getSafeRatio();return e>=i?e/i:i/e}getRelativeCoord(t){return t.isUnknown()?new n:new n(this._width/t.getSafeWidth(),this._height/t.getSafeHeight())}toString(){return`{width=${this._width.toFixed(3)}px, height=${this._height.toFixed(3)}px}`}equals(t){return this._width===t.getWidth()&&this._height===t.getHeight()}}class h{constructor(t,e,s){this.id=null!=t?t:"",this.position=null!=e?e:new i,this.size=null!=s?s:new n,this._unknown=!e||!s}setFields(t,h){var o,a;const g=t.shape?t.shape.toLowerCase():"rectangle";if("rectangle"!==g)return h.debug(`Region ${t.id} has unknown shape ${g}, skipping.`),void(this._unknown=!0);let r=null===(o=t.unit)||void 0===o?void 0:o.toLowerCase();if(r||(t.imageWidth&&t.imageHeight?r="pixel":t.imageWidth||t.imageHeight||(r="relative")),"relative"!==r&&"pixel"!==r)return h.debug(`Region ${t.id} has unknown unit ${r}, skipping.`),void(this._unknown=!0);let l=new s;if("pixel"===r){if(null==t.imageWidth||null==t.imageHeight)return h.warn(`Region ${t.id} has missing imageWidth or imageHeight, skipping.`),void(this._unknown=!0);l=new s(parseFloat(`${t.imageWidth}`),parseFloat(`${t.imageHeight}`))}if(null==t.x||null==t.y||null==t.width||null==t.height)return h.warn(`Region ${t.id} has missing x, y, width or height, skipping.`),void(this._unknown=!0);const d=parseFloat(`${t.x}`),_=parseFloat(`${t.y}`),u=parseFloat(`${t.width}`),m=parseFloat(`${t.height}`);return Number.isNaN(d)||Number.isNaN(_)||Number.isNaN(u)||Number.isNaN(m)?(h.warn(`Region ${t.id} has non-numeric x, y, width or height, skipping.`),void(this._unknown=!0)):d<0||_<0||u<=0||m<=0?(h.warn(`Region ${t.id} has negative/zero x, y, width or height, skipping.`),void(this._unknown=!0)):("relative"===r?(this.position=new i(d,_),this.size=new n(u,m)):(this.position=new e(d,_).getRelativeCoord(l),this.size=new s(u,m).getRelativeCoord(l)),this.id=null!==(a=t.id)&&void 0!==a?a:window.crypto.randomUUID(),void(this._unknown=!1))}isUnknown(){return this._unknown}getCssTransformation(t,i,n){const h=this.position.getPositionInPixels(i),o=this.size.getSizeInPixels(i),a=o.getSafeWidth(),g=o.getSafeHeight(),r=t.getSafeWidth(),l=t.getSafeHeight(),d=i.getWidth(),_=i.getHeight(),u=d-a-h.x,m=_-g-h.y;let w=0,c=0,p=1;if(t.getSafeRatio()<o.getSafeRatio()){p=r/a,c=(l/p-g)/2;(c-h.y>0||c-m>0)&&(c=Math.min(h.y,m),p=l/(2*c+g),w=(r/p-a)/2)}else{p=l/g,w=(r/p-a)/2;(w-h.x>0||w-u>0)&&(w=Math.min(h.x,u),p=r/(2*w+a),c=(l/p-g)/2)}const f=new e(h.x-w,h.y-c);return{origin:f,factor:p,insetClipFromTopLeft:new s(f.x,f.y),insetClipFromBottomRight:new s(u-w+n.getWidth(),m-c+n.getHeight())}}}class o extends HTMLImageElement{constructor(){super(),this._rectangleImageRegions=[],this._attributeObserver=new MutationObserver(this._attributeHasChanged.bind(this)),this._elementSize=new s,this._fittedImageSize=new s,this._fittedImageBottomRightMargin=new s,this._logger=new t(this.id,this.dataset.loglevel),this.style.objectFit="contain",this.style.objectPosition="top left",this.style.border="none",this.style.padding="0",this.parentElement&&"paint"!==this.parentElement.style.contain&&"layout"!==this.parentElement.style.contain&&"content"!==this.parentElement.style.contain&&(this.parentElement.style.contain="paint"),this._attributeObserver.observe(this,{attributeFilter:["id","data-loglevel","data-image-regions","data-image-region-id"]}),window.setInterval((()=>{this._observeElementSize()}),o._SIZE_OBSERVER_PERIOD_MS),this._populateRectangleImageRegions()}_attributeHasChanged(t){t.forEach((t=>{if("attributes"===t.type)switch(t.attributeName){case"id":this._logger.setId(this.id);break;case"data-loglevel":this._logger.setLevel(this.dataset.loglevel);break;case"data-image-regions":this._populateRectangleImageRegions(),this._panAndZoomToBestFittingRegion();break;case"data-image-region-id":this._panAndZoomToBestFittingRegion();break;default:this._logger.warn(`Unexpected attribute mutation: ${t.attributeName}`)}else this._logger.warn(`Unexpected mutation type: ${t.type}`)}))}_populateRectangleImageRegions(){this._logger.debug("Populating rectangle image regions..."),this._rectangleImageRegions=[];let t=[],e=!1;try{t=JSON.parse(this.dataset.imageRegions||"[]")}catch(t){e=!0}e||(e=!Array.isArray(t)),e&&(this._logger.warn("Invalid 'data-image-regions' attribute"),t=[]),t.forEach((t=>{const e=new h;e.setFields(t,this._logger),e.isUnknown()||(this._logger.debug(`Rectangle region found: id=${e.id}, position=${e.position}, size=${e.size}`),this._rectangleImageRegions.push(e))})),this._rectangleImageRegions.length||this._logger.debug("No rectangle image region found")}_observeElementSize(){const t=new s(this.offsetWidth,this.offsetHeight);this._elementSize.setIfDifferent(t)&&(this._logger.debug(`Element size: ${this._elementSize}`),this._populateFittedImageSize(),this._panAndZoomToBestFittingRegion())}_populateFittedImageSize(){const t=new s(this.naturalWidth,this.naturalHeight);let e=1;e=this._elementSize.getSafeRatio()<t.getSafeRatio()?this._elementSize.getSafeWidth()/t.getSafeWidth():this._elementSize.getSafeHeight()/t.getSafeHeight(),this._fittedImageSize=new s(this.naturalWidth*e,this.naturalHeight*e),this._fittedImageBottomRightMargin=new s(this._elementSize.getWidth()-this._fittedImageSize.getWidth(),this._elementSize.getHeight()-this._fittedImageSize.getHeight()),this._logger.debug(`Fitted image size: ${this._fittedImageSize}`),this._logger.debug(`Fitted image margin: ${this._fittedImageBottomRightMargin}`)}_panAndZoomToBestFittingRegion(){if(this._logger.debug("Panning and zooming to best fitting region..."),this._fittedImageSize.isUnknown())return void this._logger.debug("Fitted image size unknown, deferring.");let t=null;this.dataset.imageRegionId&&(t=this._rectangleImageRegions.find((t=>t.id===this.dataset.imageRegionId))),t||(t=this._findBestFittingRegion());const e=t.getCssTransformation(this._elementSize,this._fittedImageSize,this._fittedImageBottomRightMargin);this.style.transformOrigin=`${e.origin.x.toFixed(3)}px ${e.origin.y.toFixed(3)}px`,this.style.transform=`translate(${-e.origin.x.toFixed(3)}px, ${-e.origin.y.toFixed(3)}px) scale(${e.factor.toFixed(3)})`,this.style.clipPath=`inset(${e.insetClipFromTopLeft.getHeight()}px ${e.insetClipFromBottomRight.getWidth()}px ${e.insetClipFromBottomRight.getHeight()}px ${e.insetClipFromTopLeft.getWidth()}px)`}_findBestFittingRegion(){let t=o._ORIGINAL_IMAGE_REGION,e=this._elementSize.ratioDiffFactor(this._fittedImageSize);return e>1.1&&this._rectangleImageRegions.forEach((i=>{const n=this._elementSize.ratioDiffFactor(i.size.getSizeInPixels(this._fittedImageSize));n<e&&(e=n,t=i)})),this._logger.debug(`Selected region: ${t.id}`),t}}o._SIZE_OBSERVER_PERIOD_MS=200,o._ORIGINAL_IMAGE_REGION=new h("<no region>",new i(0,0),new n(1,1)),window.customElements.define("image-display-control",o,{extends:"img"});
