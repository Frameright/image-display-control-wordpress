/*! (c) Andrea Giammarchi @webreflection ISC */
!function(){var e=function(e,t){var i=function(e){for(var t=0,i=e.length;t<i;t++)n(e[t])},n=function(e){var t=e.target,i=e.attributeName,n=e.oldValue;t.attributeChangedCallback(i,n,t.getAttribute(i))};return function(s,r){var o=s.constructor.observedAttributes;return o&&e(r).then((function(){new t(i).observe(s,{attributes:!0,attributeOldValue:!0,attributeFilter:o});for(var e=0,r=o.length;e<r;e++)s.hasAttribute(o[e])&&n({target:s,attributeName:o[e],oldValue:null})})),s}};function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function i(e,i){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,i){if(e){if("string"==typeof e)return t(e,i);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?t(e,i):void 0}}(e))||i&&e&&"number"==typeof e.length){n&&(e=n);var s=0,r=function(){};return{s:r,n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){l=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(l)throw o}}}}
/*! (c) Andrea Giammarchi - ISC */var n=!0,s=!1,r="querySelectorAll",o="querySelectorAll",a=self,l=a.document,h=a.Element,g=a.MutationObserver,d=a.Set,u=a.WeakMap,c=function(e){return o in e},f=[].filter,_=function(e){var t=new u,a=function(i,n){var s;if(n)for(var r,o=function(e){return e.matches||e.webkitMatchesSelector||e.msMatchesSelector}(i),a=0,l=m.length;a<l;a++)o.call(i,r=m[a])&&(t.has(i)||t.set(i,new d),(s=t.get(i)).has(r)||(s.add(r),e.handle(i,n,r)));else t.has(i)&&(s=t.get(i),t.delete(i),s.forEach((function(t){e.handle(i,n,t)})))},_=function(e){for(var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=0,n=e.length;i<n;i++)a(e[i],t)},m=e.query,p=e.root||l,w=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:MutationObserver,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:["*"],l=function t(s,o,a,l,h,g){var d,u=i(s);try{for(u.s();!(d=u.n()).done;){var c=d.value;(g||r in c)&&(h?a.has(c)||(a.add(c),l.delete(c),e(c,h)):l.has(c)||(l.add(c),a.delete(c),e(c,h)),g||t(c[r](o),o,a,l,h,n))}}catch(e){u.e(e)}finally{u.f()}},h=new o((function(e){if(a.length){var t,r=a.join(","),o=new Set,h=new Set,g=i(e);try{for(g.s();!(t=g.n()).done;){var d=t.value,u=d.addedNodes,c=d.removedNodes;l(c,r,o,h,s,s),l(u,r,o,h,n,s)}}catch(e){g.e(e)}finally{g.f()}}})),g=h.observe;return(h.observe=function(e){return g.call(h,e,{subtree:n,childList:n})})(t),h}(a,p,g,m),v=h.prototype.attachShadow;return v&&(h.prototype.attachShadow=function(e){var t=v.call(this,e);return w.observe(t),t}),m.length&&_(p[o](m)),{drop:function(e){for(var i=0,n=e.length;i<n;i++)t.delete(e[i])},flush:function(){for(var e=w.takeRecords(),t=0,i=e.length;t<i;t++)_(f.call(e[t].removedNodes,c),!1),_(f.call(e[t].addedNodes,c),!0)},observer:w,parse:_}},m=self,p=m.document,w=m.Map,v=m.MutationObserver,b=m.Object,y=m.Set,R=m.WeakMap,S=m.Element,x=m.HTMLElement,C=m.Node,I=m.Error,E=m.TypeError,k=m.Reflect,z=b.defineProperty,T=b.keys,O=b.getOwnPropertyNames,$=b.setPrototypeOf,F=!self.customElements,A=function(e){for(var t=T(e),i=[],n=t.length,s=0;s<n;s++)i[s]=e[t[s]],delete e[t[s]];return function(){for(var s=0;s<n;s++)e[t[s]]=i[s]}};if(F){var M=function(){var e=this.constructor;if(!P.has(e))throw new E("Illegal constructor");var t=P.get(e);if(U)return G(U,t);var i=N.call(p,t);return G($(i,e.prototype),t)},N=p.createElement,P=new w,H=new w,W=new w,B=new w,L=[],D=_({query:L,handle:function(e,t,i){var n=W.get(i);if(t&&!n.isPrototypeOf(e)){var s=A(e);U=$(e,n);try{new n.constructor}finally{U=null,s()}}var r="".concat(t?"":"dis","connectedCallback");r in n&&e[r]()}}).parse,U=null,q=function(e){if(!H.has(e)){var t,i=new Promise((function(e){t=e}));H.set(e,{$:i,_:t})}return H.get(e).$},G=e(q,v);z(self,"customElements",{configurable:!0,value:{define:function(e,t){if(B.has(e))throw new I('the name "'.concat(e,'" has already been used with this registry'));P.set(t,e),W.set(e,t.prototype),B.set(e,t),L.push(e),q(e).then((function(){D(p.querySelectorAll(e))})),H.get(e)._(t)},get:function(e){return B.get(e)},whenDefined:q}}),z(M.prototype=x.prototype,"constructor",{value:M}),z(self,"HTMLElement",{configurable:!0,value:M}),z(p,"createElement",{configurable:!0,value:function(e,t){var i=t&&t.is,n=i?B.get(i):B.get(e);return n?new n:N.call(p,e)}}),"isConnected"in C.prototype||z(C.prototype,"isConnected",{configurable:!0,get:function(){return!(this.ownerDocument.compareDocumentPosition(this)&this.DOCUMENT_POSITION_DISCONNECTED)}})}else if(F=!self.customElements.get("extends-li"))try{var j=function e(){return self.Reflect.construct(HTMLLIElement,[],e)};j.prototype=HTMLLIElement.prototype;var V="extends-li";self.customElements.define("extends-li",j,{extends:"li"}),F=p.createElement("li",{is:V}).outerHTML.indexOf(V)<0;var Z=self.customElements,J=Z.get,K=Z.whenDefined;z(self.customElements,"whenDefined",{configurable:!0,value:function(e){var t=this;return K.call(this,e).then((function(i){return i||J.call(t,e)}))}})}catch(e){}if(F){var Q=function(e){var t=re.get(e);fe(t.querySelectorAll(this),e.isConnected)},X=self.customElements,Y=p.createElement,ee=X.define,te=X.get,ie=X.upgrade,ne=k||{construct:function(e){return e.call(this)}},se=ne.construct,re=new R,oe=new y,ae=new w,le=new w,he=new w,ge=new w,de=[],ue=[],ce=function(e){return ge.get(e)||te.call(X,e)},fe=_({query:ue,handle:function(e,t,i){var n=he.get(i);if(t&&!n.isPrototypeOf(e)){var s=A(e);ve=$(e,n);try{new n.constructor}finally{ve=null,s()}}var r="".concat(t?"":"dis","connectedCallback");r in n&&e[r]()}}).parse,_e=_({query:de,handle:function(e,t){re.has(e)&&(t?oe.add(e):oe.delete(e),ue.length&&Q.call(ue,e))}}).parse,me=S.prototype.attachShadow;me&&(S.prototype.attachShadow=function(e){var t=me.call(this,e);return re.set(this,t),t});var pe=function(e){if(!le.has(e)){var t,i=new Promise((function(e){t=e}));le.set(e,{$:i,_:t})}return le.get(e).$},we=e(pe,v),ve=null;O(self).filter((function(e){return/^HTML.*Element$/.test(e)})).forEach((function(e){var t=self[e];function i(){var e=this.constructor;if(!ae.has(e))throw new E("Illegal constructor");var i=ae.get(e),n=i.is,s=i.tag;if(n){if(ve)return we(ve,n);var r=Y.call(p,s);return r.setAttribute("is",n),we($(r,e.prototype),n)}return se.call(this,t,[],e)}z(i.prototype=t.prototype,"constructor",{value:i}),z(self,e,{value:i})})),z(p,"createElement",{configurable:!0,value:function(e,t){var i=t&&t.is;if(i){var n=ge.get(i);if(n&&ae.get(n).tag===e)return new n}var s=Y.call(p,e);return i&&s.setAttribute("is",i),s}}),z(X,"get",{configurable:!0,value:ce}),z(X,"whenDefined",{configurable:!0,value:pe}),z(X,"upgrade",{configurable:!0,value:function(e){var t=e.getAttribute("is");if(t){var i=ge.get(t);if(i)return void we($(e,i.prototype),t)}ie.call(X,e)}}),z(X,"define",{configurable:!0,value:function(e,t,i){if(ce(e))throw new I("'".concat(e,"' has already been defined as a custom element"));var n,s=i&&i.extends;ae.set(t,s?{is:e,tag:s}:{is:"",tag:e}),s?(n="".concat(s,'[is="').concat(e,'"]'),he.set(n,t.prototype),ge.set(e,t),ue.push(n)):(ee.apply(X,arguments),de.push(n=e)),pe(e).then((function(){s?(fe(p.querySelectorAll(n)),oe.forEach(Q,[n])):_e(p.querySelectorAll(n))})),le.get(e)._(t)}})}}();class e{constructor(t,i){this._id=t,this._level=e._toValue(i)}setLevel(t){this._level=e._toValue(t)}setId(e){this._id=e}debug(t){this._level>=e._DEBUG&&console.log(this._consoleText(t))}warn(t){this._level>=e._WARN&&console.warn(this._consoleText(t))}error(t){this._level>=e._ERROR&&console.error(this._consoleText(t))}static _toValue(t){const i=(t||"").toLowerCase();return"debug"===i||"trace"===i||"notice"===i?e._DEBUG:"info"===i?e._INFO:i.startsWith("warn")?e._WARN:i.startsWith("err")?e._ERROR:"fatal"===i?e._FATAL:e._OFF}_consoleText(e){return this._id?`[${this._id}] ${e}`:e}}e._OFF=0,e._FATAL=1,e._ERROR=2,e._WARN=3,e._INFO=4,e._DEBUG=5;class t{constructor(e,t){this.x=e,this.y=t}getRelativeCoord(e){return e.isUnknown()?new i:new i(this.x/e.getSafeWidth(),this.y/e.getSafeHeight())}toString(){return`{x=${this.x.toFixed(3)}px, y=${this.y.toFixed(3)}px}`}}class i{constructor(e,t){this._x=Math.max(Math.min(null!=e?e:0,1),0),this._y=Math.max(Math.min(null!=t?t:0,1),0)}getPositionInPixels(e){let i=0,n=0;return e.isUnknown()||(i=e.getWidth(),n=e.getHeight()),new t(this._x*i,this._y*n)}toString(){return`{x=${this._x.toFixed(3)}, y=${this._y.toFixed(3)}}`}}class n{constructor(e,t){this._width=Math.max(Math.min(null!=e?e:0,1),0),this._height=Math.max(Math.min(null!=t?t:0,1),0)}getSizeInPixels(e){let t=0,i=0;return e.isUnknown()||(t=e.getWidth(),i=e.getHeight()),new s(this._width*t,this._height*i)}toString(){return`{width=${this._width.toFixed(3)}, height=${this._height.toFixed(3)}}`}}class s{constructor(e,t){this._unknown=!0,this._width=0,this._height=0,null!=e&&null!=t&&(this._width=Math.max(e,0),this._height=Math.max(t,0),this._unknown=!1)}getWidth(){return this._width}getHeight(){return this._height}getSafeWidth(){return Math.max(this._width,1)}getSafeHeight(){return Math.max(this._height,1)}getSafeRatio(){return this.getSafeWidth()/this.getSafeHeight()}isUnknown(){return this._unknown}setIfDifferent(e){return!this.equals(e)&&(this._unknown=e.isUnknown(),this._width=e.getWidth(),this._height=e.getHeight(),!0)}ratioDiffFactor(e){const t=this.getSafeRatio(),i=e.getSafeRatio();return t>=i?t/i:i/t}getRelativeCoord(e){return e.isUnknown()?new n:new n(this._width/e.getSafeWidth(),this._height/e.getSafeHeight())}toString(){return`{width=${this._width.toFixed(3)}px, height=${this._height.toFixed(3)}px}`}equals(e){return this._width===e.getWidth()&&this._height===e.getHeight()}}class r{constructor(e,t,s){this.id=null!=e?e:"",this.position=null!=t?t:new i,this.size=null!=s?s:new n,this._unknown=!t||!s}setFields(e,r){var o,a;const l=e.shape?e.shape.toLowerCase():"rectangle";if("rectangle"!==l)return r.debug(`Region ${e.id} has unknown shape ${l}, skipping.`),void(this._unknown=!0);let h=null===(o=e.unit)||void 0===o?void 0:o.toLowerCase();if(h||(e.imageWidth&&e.imageHeight?h="pixel":e.imageWidth||e.imageHeight||(h="relative")),"relative"!==h&&"pixel"!==h)return r.debug(`Region ${e.id} has unknown unit ${h}, skipping.`),void(this._unknown=!0);let g=new s;if("pixel"===h){if(null==e.imageWidth||null==e.imageHeight)return r.warn(`Region ${e.id} has missing imageWidth or imageHeight, skipping.`),void(this._unknown=!0);g=new s(parseFloat(`${e.imageWidth}`),parseFloat(`${e.imageHeight}`))}if(null==e.x||null==e.y||null==e.width||null==e.height)return r.warn(`Region ${e.id} has missing x, y, width or height, skipping.`),void(this._unknown=!0);const d=parseFloat(`${e.x}`),u=parseFloat(`${e.y}`),c=parseFloat(`${e.width}`),f=parseFloat(`${e.height}`);return Number.isNaN(d)||Number.isNaN(u)||Number.isNaN(c)||Number.isNaN(f)?(r.warn(`Region ${e.id} has non-numeric x, y, width or height, skipping.`),void(this._unknown=!0)):d<0||u<0||c<=0||f<=0?(r.warn(`Region ${e.id} has negative/zero x, y, width or height, skipping.`),void(this._unknown=!0)):("relative"===h?(this.position=new i(d,u),this.size=new n(c,f)):(this.position=new t(d,u).getRelativeCoord(g),this.size=new s(c,f).getRelativeCoord(g)),this.id=null!==(a=e.id)&&void 0!==a?a:window.crypto.randomUUID(),void(this._unknown=!1))}isUnknown(){return this._unknown}getCssTransformation(e,i,n){const r=this.position.getPositionInPixels(i),o=this.size.getSizeInPixels(i),a=o.getSafeWidth(),l=o.getSafeHeight(),h=e.getSafeWidth(),g=e.getSafeHeight(),d=i.getWidth(),u=i.getHeight(),c=d-a-r.x,f=u-l-r.y;let _=0,m=0,p=1;if(e.getSafeRatio()<o.getSafeRatio()){p=h/a,m=(g/p-l)/2;(m-r.y>0||m-f>0)&&(m=Math.min(r.y,f),p=g/(2*m+l),_=(h/p-a)/2)}else{p=g/l,_=(h/p-a)/2;(_-r.x>0||_-c>0)&&(_=Math.min(r.x,c),p=h/(2*_+a),m=(g/p-l)/2)}const w=new t(r.x-_,r.y-m);return{origin:w,factor:p,insetClipFromTopLeft:new s(w.x,w.y),insetClipFromBottomRight:new s(c-_+n.getWidth(),f-m+n.getHeight())}}}class o extends HTMLImageElement{constructor(){super(...arguments),this._rectangleImageRegions=[],this._sizeObserver=new ResizeObserver(this._resizeCallback.bind(this)),this._elementSize=new s,this._fittedImageSize=new s,this._fittedImageBottomRightMargin=new s,this._parentElement=null,this._parentCssContainToRestore=null,this._cssBorderToRestore=null,this._cssPaddingToRestore=null,this._logger=new e(this.id,this.dataset.loglevel)}static get observedAttributes(){return["id","data-loglevel","data-disabled","data-image-regions","data-image-region-id"]}connectedCallback(){this._logger.debug("Connected"),this._behaviorChanged()}disconnectedCallback(){this._logger.debug("Disconnected"),this._restoreOriginalParentCssContainment()}attributeChangedCallback(e){switch(e){case"id":this._logger.setId(this.id);break;case"data-loglevel":this._logger.setLevel(this.dataset.loglevel);break;case"data-disabled":this._behaviorChanged();break;case"data-image-regions":this.dataset.disabled||(this._populateRectangleImageRegions(),this._panAndZoomToBestRegion());break;case"data-image-region-id":this.dataset.disabled||this._panAndZoomToBestRegion();break;default:this._logger.warn(`Unexpected attribute mutation: ${e}`)}}_behaviorChanged(){switch(this.dataset.disabled||"none"){case"all":case"true":case"yes":this._logger.debug("Disabled"),this._sizeObserver.unobserve(this),this._restoreOriginalBorderAndPadding(),this._setCssToMiddleCropOriginalImage(),this._restoreOriginalParentCssContainment();break;case"css-contain":case"css-containment":this._logger.debug("Disabled CSS containment only"),this._restoreOriginalParentCssContainment();break;default:this._logger.debug("Enabled"),this._adaptParentCssContainment(),this._populateRectangleImageRegions(),this._panAndZoomToBestRegion(),this._sizeObserver.observe(this)}}_resizeCallback(e){const t=e.pop();if(!t)return void this._logger.warn("No ResizeObserverEntry, spurious call?");if(t.target!==this)return void this._logger.warn("Unexpected ResizeObserverEntry target");let i=new s;i=t.contentBoxSize?new s(t.contentBoxSize[0].inlineSize,t.contentBoxSize[0].blockSize):new s(t.contentRect.width,t.contentRect.height);this._elementSize.setIfDifferent(i)&&(this._logger.debug(`Element size: ${this._elementSize}`),this._populateFittedImageSize(),this._panAndZoomToBestRegion())}_populateRectangleImageRegions(){this._logger.debug("Populating rectangle image regions..."),this._rectangleImageRegions=[];let e=[],t=!1;try{e=JSON.parse(this.dataset.imageRegions||"[]")}catch(e){t=!0}t||(t=!Array.isArray(e)),t&&(this._logger.warn("Invalid 'data-image-regions' attribute"),e=[]),e.forEach((e=>{const t=new r;t.setFields(e,this._logger),t.isUnknown()||(this._logger.debug(`Rectangle region found: id=${t.id}, position=${t.position}, size=${t.size}`),this._rectangleImageRegions.push(t))})),this._rectangleImageRegions.length||this._logger.debug("No rectangle image region found")}_populateFittedImageSize(){const e=new s(this.naturalWidth,this.naturalHeight);let t=1;t=this._elementSize.getSafeRatio()<e.getSafeRatio()?this._elementSize.getSafeWidth()/e.getSafeWidth():this._elementSize.getSafeHeight()/e.getSafeHeight(),this._fittedImageSize=new s(this.naturalWidth*t,this.naturalHeight*t),this._fittedImageBottomRightMargin=new s(this._elementSize.getWidth()-this._fittedImageSize.getWidth(),this._elementSize.getHeight()-this._fittedImageSize.getHeight()),this._logger.debug(`Fitted image size: ${this._fittedImageSize}`),this._logger.debug(`Fitted image margin: ${this._fittedImageBottomRightMargin}`)}_panAndZoomToBestRegion(){if(this._logger.debug("Panning and zooming to best region..."),this._fittedImageSize.isUnknown())return void this._logger.debug("Fitted image size unknown, deferring.");let e=null;if(this.dataset.imageRegionId&&(e=this._rectangleImageRegions.find((e=>e.id===this.dataset.imageRegionId))),e||(e=this._findBestRegion()),o._ORIGINAL_IMAGE_REGION.id===e.id)this._restoreOriginalBorderAndPadding(),this._setCssToMiddleCropOriginalImage();else{null===this._cssBorderToRestore&&(this._cssBorderToRestore=this.style.border,this.style.border="none"),null===this._cssPaddingToRestore&&(this._cssPaddingToRestore=this.style.padding,this.style.padding="0"),this.style.objectFit="contain",this.style.objectPosition="top left";const t=e.getCssTransformation(this._elementSize,this._fittedImageSize,this._fittedImageBottomRightMargin);this.style.transformOrigin=`${t.origin.x.toFixed(3)}px ${t.origin.y.toFixed(3)}px`,this.style.transform=`translate(${-t.origin.x.toFixed(3)}px, ${-t.origin.y.toFixed(3)}px) scale(${t.factor.toFixed(3)})`,this.style.clipPath=`inset(${t.insetClipFromTopLeft.getHeight()}px ${t.insetClipFromBottomRight.getWidth()}px ${t.insetClipFromBottomRight.getHeight()}px ${t.insetClipFromTopLeft.getWidth()}px)`}}_findBestRegion(){let e=o._ORIGINAL_IMAGE_REGION,t=this._elementSize.ratioDiffFactor(this._fittedImageSize);return t>1.1&&this._rectangleImageRegions.forEach((i=>{const n=this._elementSize.ratioDiffFactor(i.size.getSizeInPixels(this._fittedImageSize));n<t&&(t=n,e=i)})),this._logger.debug(`Selected region: ${e.id}`),e}_adaptParentCssContainment(){this._parentElement=this.parentElement,this._parentElement&&"paint"!==this._parentElement.style.contain&&"layout"!==this._parentElement.style.contain&&"content"!==this._parentElement.style.contain&&(null===this._parentCssContainToRestore&&(this._parentCssContainToRestore=this._parentElement.style.contain),this._parentElement.style.contain="paint")}_restoreOriginalParentCssContainment(){this._parentElement&&null!==this._parentCssContainToRestore&&(this._parentElement.style.contain=this._parentCssContainToRestore,this._parentCssContainToRestore=null)}_restoreOriginalBorderAndPadding(){null!==this._cssBorderToRestore&&(this.style.border=this._cssBorderToRestore,this._cssBorderToRestore=null),null!==this._cssPaddingToRestore&&(this.style.padding=this._cssPaddingToRestore,this._cssPaddingToRestore=null)}_setCssToMiddleCropOriginalImage(){this.style.objectFit="cover",this.style.objectPosition="center",this.style.transformOrigin="0 0",this.style.transform="none",this.style.clipPath="none"}}o._ORIGINAL_IMAGE_REGION=new r("<no region>",new i(0,0),new n(1,1)),window.customElements.define("image-display-control",o,{extends:"img"});
